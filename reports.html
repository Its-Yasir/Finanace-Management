<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Personal Expense Tracker - Reports and Analytics">
  <title>Reports - Personal Expense Tracker</title>

  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="assets/logo.svg">
  <link rel="alternate icon" href="assets/logo.png">
  
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- FontAwesome Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  
  <!-- Custom Styles -->
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <!-- Mobile Toggle -->
  <button class="mobile-toggle" id="mobileToggle">
    <i class="fas fa-bars"></i>
  </button>
  
  <!-- Sidebar Overlay -->
  <div class="sidebar-overlay" id="sidebarOverlay"></div>

  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar">
    <!-- Desktop Toggle Button -->
    <button class="sidebar-toggle" id="sidebarToggle">
      <i class="fas fa-chevron-left"></i>
    </button>

    <div class="navbar-brand">
      <img src="assets/logo.svg" onerror="this.onerror=null; this.src='assets/logo.png';" alt="PET Logo">
      <span>PET</span>
    </div>
    
    <ul class="navbar-nav">
      <li><a href="dashboard.html"><i class="fas fa-home"></i> <span class="nav-text">Dashboard</span></a></li>
      <li><a href="transactions.html"><i class="fas fa-exchange-alt"></i> <span class="nav-text">Transactions</span></a></li>
      <li><a href="expenses.html"><i class="fas fa-list"></i> <span class="nav-text">Expenses</span></a></li>
      <li><a href="reports.html" class="active"><i class="fas fa-chart-pie"></i> <span class="nav-text">Reports</span></a></li>
      <li style="margin-bottom: 15px;"><a href="settings.html"><i class="fas fa-cog"></i> <span class="nav-text">Settings</span></a></li>
    </ul>

    <div class="user-profile">
      <img src="assets/user.png" alt="User Avatar" class="user-avatar">
      <div class="user-info">
        <div class="user-name">User</div>
        <div class="user-email" id="userEmail">user@example.com</div>
      </div>
      <button id="logoutBtn" class="btn-logout" aria-label="Logout">
        <i class="fas fa-sign-out-alt"></i>
      </button>
    </div>
  </aside>

  <!-- Floating Theme Toggle -->
  <button id="themeToggle" class="theme-toggle-floating" aria-label="Toggle theme">
    <i class="fas fa-moon"></i>
  </button>

  <!-- Main Content -->
  <main class="main-content">
  <div class="container page-content">
    <!-- Page Header -->
    <div class="section-header">
      <h1 class="section-title">Reports & Analytics</h1>
      <p class="section-subtitle">Visualize your spending patterns</p>
    </div>

    <!-- Summary Stats -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon">
          <i class="fas fa-receipt"></i>
        </div>
        <div class="stat-label">Total Expenses</div>
        <div class="stat-value" id="totalExpenses">$0.00</div>
      </div>

      <div class="stat-card" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">
        <div class="stat-icon">
          <i class="fas fa-tags"></i>
        </div>
        <div class="stat-label">Categories</div>
        <div class="stat-value" id="totalCategories">0</div>
      </div>

      <div class="stat-card expense">
        <div class="stat-icon">
          <i class="fas fa-chart-line"></i>
        </div>
        <div class="stat-label">Avg. Monthly</div>
        <div class="stat-value" id="avgMonthly">$0.00</div>
      </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loading" class="loading">
      <div class="spinner"></div>
    </div>

    <!-- Charts Section -->
    <div id="chartsSection" class="hidden">
      <!-- Week Navigation -->
      <div class="card mb-4">
        <div class="card-body" style="padding: var(--space-3);">
          <div style="display: flex; justify-content: space-between; align-items: center; gap: var(--space-2); flex-wrap: wrap;">
            <button id="prevWeek" class="btn btn-secondary btn-sm">
              <i class="fas fa-chevron-left"></i> <span class="hide-on-small">Previous Week</span>
            </button>
            <h3 id="weekRange" style="margin: 0; font-size: 1rem; font-weight: 600; flex: 1; min-width: 140px; text-align: center;">Loading...</h3>
            <button id="nextWeek" class="btn btn-secondary btn-sm">
              <span class="hide-on-small">Next Week</span> <i class="fas fa-chevron-right"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- Weekly Charts Grid (2 columns) -->
      <div class="charts-grid">
        <!-- Weekly Expenses Chart -->
        <div class="section">
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">
                <i class="fas fa-chart-line"></i> Weekly Expenses
              </h2>
              <p class="text-secondary" style="font-size: 0.875rem;">
                Daily expenses for the selected week
              </p>
            </div>
            <div class="card-body">
              <canvas id="weeklyExpensesChart" style="max-height: 250px;"></canvas>
            </div>
          </div>
        </div>

        <!-- Weekly Income Chart -->
        <div class="section">
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">
                <i class="fas fa-chart-area"></i> Weekly Income
              </h2>
              <p class="text-secondary" style="font-size: 0.875rem;">
                Daily income for the selected week
              </p>
            </div>
            <div class="card-body">
              <canvas id="weeklyIncomeChart" style="max-height: 250px;"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- Daily Detail Chart -->
      <div class="section">
        <div class="card">
          <div class="card-header">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: var(--space-3);">
              <div>
                <h2 class="card-title">
                  <i class="fas fa-calendar-day"></i> Daily Transactions
                </h2>
                <p class="text-secondary" style="font-size: 0.875rem;">
                  Income and expenses for <span id="selectedDayDisplay">today</span>
                </p>
              </div>
              <div class="form-group mb-0">
                <input type="date" id="dayPicker" class="form-input" style="padding: var(--space-2) var(--space-3);">
              </div>
            </div>
          </div>
          <div class="card-body">
            <canvas id="dailyChart" style="max-height: 300px;"></canvas>
          </div>
        </div>
      </div>

      <!-- Category Breakdown Table -->
      <div class="section">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">
              <i class="fas fa-table"></i> Category Breakdown
            </h2>
            <p class="text-secondary" style="font-size: 0.875rem;">
              Detailed view of spending by category
            </p>
          </div>
          <div class="card-body">
            <div id="categoryTableContainer"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Empty State -->
    <div id="emptyState" class="empty-state hidden">
      <img src="assets/empty-state.png" alt="No data">
      <h3>No Expenses Added Yet</h3>
      <p>Start adding expenses to see your reports and analytics</p>
      <button class="btn btn-primary" onclick="window.location.href='expenses.html'">
        <i class="fas fa-plus"></i> Add Expenses
      </button>
    </div>
  </div>
  </main>

  <!-- Application Script -->
  <script type="module">
    import { 
      initApp, 
      getExpenses,
      getIncome,
      calculateTotalExpenses,
      calculateCategoryTotals,
      formatCurrency,
      getCategoryIcon,
      getCategoryBadge,
      showError,
      hideLoading,
      showStatsLoading,
      hideStatsLoading
    } from './app.js';

    let currentWeekOffset = 0; // 0 = current week, -1 = previous week, +1 = next week
    let allExpenses = [];
    let allIncome = [];
    let weeklyExpensesChart = null;
    let weeklyIncomeChart = null;
    let dailyChart = null;

    // Initialize page and load reports
    async function initializePage() {
      try {
        // Show loading on stats
        showStatsLoading();
        
        // Initialize app
        await initApp();
        
        // Load data
        [allExpenses, allIncome] = await Promise.all([
          getExpenses(),
          getIncome()
        ]);
        
        if (allExpenses.length === 0 && allIncome.length === 0) {
          // Hide stats loading
          hideStatsLoading();
          // Show empty state
          document.getElementById('emptyState').classList.remove('hidden');
          hideLoading();
          return;
        }
        
        // Calculate analytics
        const totalExpenses = calculateTotalExpenses(allExpenses);
        const categoryTotals = calculateCategoryTotals(allExpenses);
        
        // Update summary stats
        document.getElementById('totalExpenses').textContent = formatCurrency(totalExpenses);
        document.getElementById('totalCategories').textContent = Object.keys(categoryTotals).length;
        
        // Calculate average monthly (simple average)
        const avgMonthly = allExpenses.length > 0 ? totalExpenses / 6 : 0;
        document.getElementById('avgMonthly').textContent = formatCurrency(avgMonthly);
        
        // Hide stats loading
        hideStatsLoading();
        
        // Show charts section
        document.getElementById('chartsSection').classList.remove('hidden');
        
        // Render weekly charts
        renderWeeklyCharts();
        
        // Render category breakdown table
        renderCategoryTable(categoryTotals, totalExpenses);
        
        // Setup week navigation
        document.getElementById('prevWeek').addEventListener('click', () => {
          currentWeekOffset--;
          renderWeeklyCharts();
        });
        
        document.getElementById('nextWeek').addEventListener('click', () => {
          currentWeekOffset++;
          renderWeeklyCharts();
        });
        
        // Setup daily chart
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        document.getElementById('dayPicker').valueAsDate = today;
        renderDailyChart(today);
        
        document.getElementById('dayPicker').addEventListener('change', (e) => {
          const selectedDate = new Date(e.target.value + 'T00:00:00');
          renderDailyChart(selectedDate);
        });
        
        // Hide loading
        hideLoading();
        
      } catch (error) {
        console.error('Error loading reports:', error);
        showError('Failed to load reports data');
        hideLoading();
      }
    }

    // Get start and end of week
    function getWeekBounds(offset) {
      const today = new Date();
      const dayOfWeek = today.getDay();
      const diff = dayOfWeek === 0 ? -6 : 1 - dayOfWeek; // Monday as first day
      
      const monday = new Date(today);
      monday.setDate(today.getDate() + diff + (offset * 7));
      monday.setHours(0, 0, 0, 0);
      
      const sunday = new Date(monday);
      sunday.setDate(monday.getDate() + 6);
      sunday.setHours(23, 59, 59, 999);
      
      return { start: monday, end: sunday };
    }

    // Format date range for display
    function formatWeekRange(start, end) {
      const options = { month: 'short', day: 'numeric' };
      const startStr = start.toLocaleDateString('en-US', options);
      const endStr = end.toLocaleDateString('en-US', options);
      return `${startStr} - ${endStr}, ${end.getFullYear()}`;
    }

    // Get daily totals for a week
    function getDailyTotals(transactions, weekStart, weekEnd) {
      const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
      const dailyTotals = new Array(7).fill(0);
      
      transactions.forEach(t => {
        const date = t.date.toDate ? t.date.toDate() : new Date(t.date);
        if (date >= weekStart && date <= weekEnd) {
          const dayIndex = date.getDay();
          const adjustedIndex = dayIndex === 0 ? 6 : dayIndex - 1; // Monday = 0
          dailyTotals[adjustedIndex] += t.amount;
        }
      });
      
      return { labels: days, data: dailyTotals };
    }

    // Render weekly charts
    function renderWeeklyCharts() {
      const { start, end } = getWeekBounds(currentWeekOffset);
      
      // Update week range display
      document.getElementById('weekRange').textContent = formatWeekRange(start, end);
      
      // Get daily data
      const expenseData = getDailyTotals(allExpenses, start, end);
      const incomeData = getDailyTotals(allIncome, start, end);
      
      // Render expenses chart
      if (weeklyExpensesChart) {
        weeklyExpensesChart.destroy();
      }
      const expCtx = document.getElementById('weeklyExpensesChart').getContext('2d');
      weeklyExpensesChart = new Chart(expCtx, {
        type: 'line',
        data: {
          labels: expenseData.labels,
          datasets: [{
            label: 'Expenses',
            data: expenseData.data,
            borderColor: 'rgb(239, 68, 68)',
            backgroundColor: 'rgba(239, 68, 68, 0.1)',
            tension: 0.3,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return 'Rs ' + value.toFixed(0);
                }
              }
            }
          }
        }
      });
      
      // Render income chart
      if (weeklyIncomeChart) {
        weeklyIncomeChart.destroy();
      }
      const incCtx = document.getElementById('weeklyIncomeChart').getContext('2d');
      weeklyIncomeChart = new Chart(incCtx, {
        type: 'line',
        data: {
          labels: incomeData.labels,
          datasets: [{
            label: 'Income',
            data: incomeData.data,
            borderColor: 'rgb(34, 197, 94)',
            backgroundColor: 'rgba(34, 197, 94, 0.1)',
            tension: 0.3,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return 'Rs ' + value.toFixed(0);
                }
              }
            }
          }
        }
      });
    }

    // Render daily transaction chart
    function renderDailyChart(selectedDate) {
      // Update display text
      const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
      const dateStr = selectedDate.toLocaleDateString('en-US', options);
      document.getElementById('selectedDayDisplay').textContent = dateStr;
      
      // Get start and end of selected day
      const dayStart = new Date(selectedDate);
      dayStart.setHours(0, 0, 0, 0);
      const dayEnd = new Date(selectedDate);
      dayEnd.setHours(23, 59, 59, 999);
      
      // Filter transactions for this day
      const dayExpenses = allExpenses.filter(t => {
        const date = t.date.toDate ? t.date.toDate() : new Date(t.date);
        return date >= dayStart && date <= dayEnd;
      });
      
      const dayIncome = allIncome.filter(t => {
        const date = t.date.toDate ? t.date.toDate() : new Date(t.date);
        return date >= dayStart && date <= dayEnd;
      });
      
      // Create hourly buckets
      const hours = Array.from({ length: 24 }, (_, i) => `${i.toString().padStart(2, '0')}:00`);
      const expenseByHour = new Array(24).fill(0);
      const incomeByHour = new Array(24).fill(0);
      
      dayExpenses.forEach(t => {
        const date = t.date.toDate ? t.date.toDate() : new Date(t.date);
        const hour = date.getHours();
        expenseByHour[hour] += t.amount;
      });
      
      dayIncome.forEach(t => {
        const date = t.date.toDate ? t.date.toDate() : new Date(t.date);
        const hour = date.getHours();
        incomeByHour[hour] += t.amount;
      });
      
      // Render chart
      if (dailyChart) {
        dailyChart.destroy();
      }
      
      const ctx = document.getElementById('dailyChart').getContext('2d');
      dailyChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: hours,
          datasets: [
            {
              label: 'Income',
              data: incomeByHour,
              borderColor: 'rgb(34, 197, 94)',
              backgroundColor: 'rgba(34, 197, 94, 0.1)',
              tension: 0.3,
              fill: false,
              pointRadius: 3,
              pointHoverRadius: 5
            },
            {
              label: 'Expenses',
              data: expenseByHour,
              borderColor: 'rgb(239, 68, 68)',
              backgroundColor: 'rgba(239, 68, 68, 0.1)',
              tension: 0.3,
              fill: false,
              pointRadius: 3,
              pointHoverRadius: 5
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: 'index',
            intersect: false
          },
          plugins: {
            legend: {
              display: true,
              position: 'top'
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  let label = context.dataset.label || '';
                  if (label) {
                    label += ': ';
                  }
                  label += 'Rs ' + context.parsed.y.toFixed(2);
                  return label;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return 'Rs ' + value.toFixed(0);
                }
              }
            },
            x: {
              ticks: {
                maxRotation: 45,
                minRotation: 45
              }
            }
          }
        }
      });
    }

    // Render category breakdown table
    function renderCategoryTable(categoryTotals, totalExpenses) {
      const container = document.getElementById('categoryTableContainer');
      
      // Sort categories by amount (descending)
      const sortedCategories = Object.entries(categoryTotals)
        .sort((a, b) => b[1] - a[1]);
      
      let html = `
        <div class="table-container">
          <table class="table">
            <thead>
              <tr>
                <th>Category</th>
                <th class="text-right">Amount</th>
                <th class="text-right">Percentage</th>
                <th style="width: 200px;">Distribution</th>
              </tr>
            </thead>
            <tbody>
      `;
      
      sortedCategories.forEach(([category, amount]) => {
        const percentage = ((amount / totalExpenses) * 100).toFixed(1);
        const icon = getCategoryIcon(category);
        const badgeClass = getCategoryBadge(category);
        
        html += `
          <tr>
            <td>
              <span class="${badgeClass}">
                <i class="fas ${icon}"></i>
                ${category}
              </span>
            </td>
            <td class="text-right text-error" style="font-weight: 600;">
              ${formatCurrency(amount)}
            </td>
            <td class="text-right" style="font-weight: 600;">
              ${percentage}%
            </td>
            <td>
              <div style="background-color: var(--bg-tertiary); border-radius: 9999px; overflow: hidden; height: 8px;">
                <div style="
                  background: linear-gradient(90deg, var(--primary-500), var(--primary-600)); 
                  width: ${percentage}%; 
                  height: 100%;
                  border-radius: 9999px;
                  transition: width 1s ease-in-out;
                "></div>
              </div>
            </td>
          </tr>
        `;
      });
      
      // Add total row
      html += `
        <tr style="background-color: var(--bg-secondary); font-weight: 700;">
          <td>TOTAL</td>
          <td class="text-right text-error">${formatCurrency(totalExpenses)}</td>
          <td class="text-right">100%</td>
          <td></td>
        </tr>
      `;
      
      html += `
            </tbody>
          </table>
        </div>
      `;
      
      container.innerHTML = html;
    }

    // Initialize page on load
    initializePage();
  </script>
</body>
</html>
